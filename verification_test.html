<!DOCTYPE html>
<html>

<head>
    <style>
        /* Minimal styling to mimic structure */
        .markdown {
            border: 1px solid #ccc;
            padding: 10px;
        }

        pre {
            background: #f0f0f0;
            padding: 10px;
        }
    </style>
</head>

<body>

    <h2>Original Input (Rendered)</h2>
    <article class="turn" data-turn="assistant">
        <div data-message-author-role="assistant">
            <div class="markdown prose dark:prose-invert w-full break-words dark markdown-new-styling">
                <p data-start="0" data-end="91">It looks like everything is fine — you just mis-typed the <code
                        data-start="58" data-end="74">git stash drop</code> command earlier.</p>
                <p data-start="93" data-end="140">Here’s what happened and how to fix it cleanly.</p>
                <hr data-start="142" data-end="145">
                <h1 data-start="147" data-end="168">✅ <strong data-start="151" data-end="168">What happened</strong>
                </h1>
                <p data-start="169" data-end="177">You ran:</p>
                <pre class="overflow-visible! px-0!" data-start="179" data-end="211">
                <div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary">
                    <div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">
                        kotlin
                    </div>
                    <div class="sticky top-9">
                        <div class="absolute end-0 bottom-0 flex h-9 items-center pe-2">
                             <div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs">
                                <button class="flex gap-1 items-center select-none py-1" aria-label="Copy">Copy code</button>
                             </div>
                        </div>
                    </div>
                    <div class="overflow-y-auto p-4" dir="ltr">
                        <code class="whitespace-pre!"><span><span>git stash drop </span><span><span class="hljs-symbol">stash@</span></span><span>{</span><span><span class="hljs-number">0</span></span><span>}</span></span></code>
                    </div>
                </div>
            </pre>
                <p data-start="213" data-end="314">…but PowerShell interpreted the <code data-start="245"
                        data-end="249">{}</code> characters as <em data-start="264" data-end="282">escape sequences</em>
                    unless you quote them.</p>
            </div>
        </div>
    </article>

    <h2>Extracted Output</h2>
    <textarea id="output" style="width: 100%; height: 300px; font-family: monospace;"></textarea>

    <script>
        // MOCK CONFIG
        const CHATGPT_CONFIG = {
            SELECTORS: {
                MODEL_CONTENT: '[data-message-author-role="assistant"]',
                MODEL_TEXT: '.markdown',
            }
        };

        // NEW FUNCTION TO TEST
        function extractModelResponseText(modelTurnElement) {
            if (!modelTurnElement) return '';

            const contentContainer = modelTurnElement.querySelector(CHATGPT_CONFIG.SELECTORS.MODEL_CONTENT);
            if (!contentContainer) return 'No content container';

            // Use specific markdown class if available, otherwise fallback to container
            const targetElement = contentContainer.querySelector(CHATGPT_CONFIG.SELECTORS.MODEL_TEXT) || contentContainer;

            // Clone to avoid modifying the actual DOM
            const clone = targetElement.cloneNode(true);

            // Process code blocks (pre elements)
            const preElements = clone.querySelectorAll('pre');
            preElements.forEach(pre => {
                // 1. Extract the code content
                const codeEl = pre.querySelector('code');
                if (!codeEl) return; // Not a standard code block
                const codeContent = codeEl.innerText;

                // 2. Extract the language (header)
                const preClone = pre.cloneNode(true);
                if (preClone.querySelector('code')) preClone.querySelector('code').remove();
                preClone.querySelectorAll('button').forEach(b => b.remove());

                // The remaining text should be the language
                const apiLang = preClone.innerText.trim();
                const language = apiLang || '';

                // 3. Replace the entire pre element with a markdown code block representation
                const markdownBlock = `\n\`\`\`${language}\n${codeContent}\n\`\`\`\n`;

                pre.replaceWith(document.createTextNode(markdownBlock));
            });

            // Remove any remaining buttons
            clone.querySelectorAll('button').forEach(el => el.remove());

            // Get the final text
            const text = clone.innerText.trim();
            return text;
        }

        // EXECUTE
        const turn = document.querySelector('article');
        const result = extractModelResponseText(turn);
        document.getElementById('output').value = result;
    </script>

</body>

</html>